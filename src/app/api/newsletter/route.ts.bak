import { NextRequest, NextResponse } from 'next/server';

// Mock newsletter subscribers
const mockSubscribers = [
  {
    id: '1',
    email: 'user1@example.com',
    name: 'John Doe',
    brand: 'konnichiwa',
    interests: ['events', 'workshops', 'cultural'],
    status: 'active',
    subscribedAt: '2024-12-01T10:00:00Z',
    lastEmailSent: '2024-12-10T15:30:00Z'
  },
  {
    id: '2', 
    email: 'user2@example.com',
    name: 'Jane Smith',
    brand: 'namaste',
    interests: ['music', 'dance', 'food'],
    status: 'active',
    subscribedAt: '2024-12-05T14:20:00Z',
    lastEmailSent: '2024-12-10T15:30:00Z'
  }
];

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const brand = searchParams.get('brand');
    const status = searchParams.get('status');

    let filteredSubscribers = [...mockSubscribers];

    // Filter by brand
    if (brand && (brand === 'konnichiwa' || brand === 'namaste')) {
      filteredSubscribers = filteredSubscribers.filter(subscriber => subscriber.brand === brand);
    }

    // Filter by status
    if (status) {
      filteredSubscribers = filteredSubscribers.filter(subscriber => subscriber.status === status);
    }

    return NextResponse.json({
      success: true,
      data: filteredSubscribers,
      total: filteredSubscribers.length
    });
  } catch (error) {
    return NextResponse.json(
      { success: false, error: 'Failed to fetch subscribers' },
      { status: 500 }
    );
  }
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { email, name, brand, interests } = body;

    // Validate required fields
    if (!email || !brand) {
      return NextResponse.json(
        { success: false, error: 'Email and brand are required' },
        { status: 400 }
      );
    }

    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      return NextResponse.json(
        { success: false, error: 'Invalid email format' },
        { status: 400 }
      );
    }

    // Check if email already exists
    const existingSubscriber = mockSubscribers.find(sub => sub.email === email);
    if (existingSubscriber) {
      return NextResponse.json(
        { success: false, error: 'Email already subscribed' },
        { status: 409 }
      );
    }

    // Validate brand
    if (!['konnichiwa', 'namaste'].includes(brand)) {
      return NextResponse.json(
        { success: false, error: 'Invalid brand' },
        { status: 400 }
      );
    }

    const newSubscriber = {
      id: (mockSubscribers.length + 1).toString(),
      email: email.toLowerCase(),
      name: name || '',
      brand,
      interests: interests || [],
      status: 'active',
      subscribedAt: new Date().toISOString(),
      lastEmailSent: null
    };

    // In production, save to database and send welcome email
    mockSubscribers.push(newSubscriber);

    return NextResponse.json({
      success: true,
      data: newSubscriber,
      message: 'Successfully subscribed to newsletter'
    });
  } catch (error) {
    return NextResponse.json(
      { success: false, error: 'Failed to subscribe to newsletter' },
      { status: 500 }
    );
  }
}

export async function PUT(request: NextRequest) {
  try {
    const body = await request.json();
    const { email, status, interests } = body;

    if (!email) {
      return NextResponse.json(
        { success: false, error: 'Email is required' },
        { status: 400 }
      );
    }

    const subscriberIndex = mockSubscribers.findIndex(sub => sub.email === email);
    if (subscriberIndex === -1) {
      return NextResponse.json(
        { success: false, error: 'Subscriber not found' },
        { status: 404 }
      );
    }

    // Update subscriber
    if (status) mockSubscribers[subscriberIndex].status = status;
    if (interests) mockSubscribers[subscriberIndex].interests = interests;

    return NextResponse.json({
      success: true,
      data: mockSubscribers[subscriberIndex],
      message: 'Subscriber updated successfully'
    });
  } catch (error) {
    return NextResponse.json(
      { success: false, error: 'Failed to update subscriber' },
      { status: 500 }
    );
  }
}

export async function DELETE(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const email = searchParams.get('email');

    if (!email) {
      return NextResponse.json(
        { success: false, error: 'Email is required' },
        { status: 400 }
      );
    }

    const subscriberIndex = mockSubscribers.findIndex(sub => sub.email === email);
    if (subscriberIndex === -1) {
      return NextResponse.json(
        { success: false, error: 'Subscriber not found' },
        { status: 404 }
      );
    }

    // Remove subscriber
    mockSubscribers.splice(subscriberIndex, 1);

    return NextResponse.json({
      success: true,
      message: 'Successfully unsubscribed from newsletter'
    });
  } catch (error) {
    return NextResponse.json(
      { success: false, error: 'Failed to unsubscribe' },
      { status: 500 }
    );
  }
}