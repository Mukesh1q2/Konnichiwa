// Enhanced email service with multiple providers support
import sgMail from '@sendgrid/mail';
import nodemailer from 'nodemailer';
import { Resend } from 'resend';

// Email configuration
const emailConfig = {
  sendgrid: {
    apiKey: process.env.SENDGRID_API_KEY!,
    fromEmail: process.env.SENDGRID_FROM_EMAIL!,
    fromName: process.env.SENDGRID_FROM_NAME || 'Konnichiwa Namaste Cultural Festival'
  },
  resend: {
    apiKey: process.env.RESEND_API_KEY!,
    fromEmail: process.env.RESEND_FROM_EMAIL!,
    fromName: process.env.RESEND_FROM_NAME || 'Konnichiwa Namaste Cultural Festival'
  },
  smtp: {
    host: process.env.SMTP_HOST!,
    port: parseInt(process.env.SMTP_PORT!),
    secure: process.env.SMTP_SECURE === 'true',
    auth: {
      user: process.env.SMTP_USER!,
      pass: process.env.SMTP_PASS!
    }
  }
};

// Initialize email providers
sgMail.setApiKey(emailConfig.sendgrid.apiKey);

const resend = new Resend(emailConfig.resend.apiKey);

const smtpTransporter = nodemailer.createTransporter(emailConfig.smtp);

// Types
export interface EmailData {
  to: string | string[];
  subject: string;
  html: string;
  text?: string;
  from?: string;
  fromName?: string;
  attachments?: EmailAttachment[];
  templateId?: string;
  templateData?: Record<string, any>;
}

export interface EmailAttachment {
  filename: string;
  content: Buffer | string;
  contentType?: string;
}

export interface TicketConfirmationEmail {
  userName: string;
  eventTitle: string;
  eventDate: string;
  eventLocation: string;
  ticketType: string;
  quantity: number;
  totalAmount: number;
  ticketId: string;
  qrCode?: string;
}

export interface EventReminderEmail {
  userName: string;
  eventTitle: string;
  eventDate: string;
  eventTime: string;
  eventLocation: string;
  eventDescription: string;
}

export interface NewsletterEmail {
  recipientName: string;
  brand: 'konnichiwa' | 'namaste';
  articles: NewsletterArticle[];
  unsubscribeUrl: string;
}

export interface NewsletterArticle {
  title: string;
  excerpt: string;
  url: string;
  imageUrl?: string;
}

export interface ContactResponseEmail {
  userName: string;
  subject: string;
  response: string;
}

export class EmailService {
  // Primary email sending method with fallback
  static async sendEmail(emailData: EmailData): Promise<{ success: boolean; error?: string }> {
    try {
      // Try SendGrid first
      const sendgridResult = await this.sendWithSendGrid(emailData);
      if (sendgridResult.success) {
        return sendgridResult;
      }

      // Fallback to Resend
      const resendResult = await this.sendWithResend(emailData);
      if (resendResult.success) {
        return resendResult;
      }

      // Final fallback to SMTP
      const smtpResult = await this.sendWithSMTP(emailData);
      return smtpResult;
    } catch (error) {
      return { success: false, error: 'Email sending failed' };
    }
  }

  // SendGrid implementation
  private static async sendWithSendGrid(emailData: EmailData): Promise<{ success: boolean; error?: string }> {
    try {
      const msg = {
        to: emailData.to,
        from: {
          email: emailData.from || emailConfig.sendgrid.fromEmail,
          name: emailData.fromName || emailConfig.sendgrid.fromName
        },
        subject: emailData.subject,
        html: emailData.html,
        text: emailData.text,
        attachments: emailData.attachments?.map(att => ({
          content: Buffer.from(att.content).toString('base64'),
          filename: att.filename,
          type: att.contentType || 'application/octet-stream',
          disposition: 'attachment'
        }))
      };

      if (emailData.templateId) {
        msg['templateId'] = emailData.templateId;
        msg['dynamicTemplateData'] = emailData.templateData;
      }

      await sgMail.send(msg);
      return { success: true };
    } catch (error) {
      return { success: false, error: 'SendGrid failed' };
    }
  }

  // Resend implementation
  private static async sendWithResend(emailData: EmailData): Promise<{ success: boolean; error?: string }> {
    try {
      const result = await resend.emails.send({
        to: emailData.to,
        from: emailData.from || emailConfig.resend.fromEmail,
        subject: emailData.subject,
        html: emailData.html,
        text: emailData.text,
        attachments: emailData.attachments?.map(att => ({
          filename: att.filename,
          content: Buffer.from(att.content).toString('base64'),
          content_type: att.contentType || 'application/octet-stream'
        }))
      });

      if (result.error) {
        return { success: false, error: result.error.message };
      }

      return { success: true };
    } catch (error) {
      return { success: false, error: 'Resend failed' };
    }
  }

  // SMTP implementation
  private static async sendWithSMTP(emailData: EmailData): Promise<{ success: boolean; error?: string }> {
    try {
      const mailOptions = {
        from: emailData.fromName 
          ? `"${emailData.fromName}" <${emailData.from || emailConfig.smtp.auth.user}>`
          : emailConfig.smtp.auth.user,
        to: Array.isArray(emailData.to) ? emailData.to.join(', ') : emailData.to,
        subject: emailData.subject,
        html: emailData.html,
        text: emailData.text,
        attachments: emailData.attachments
      };

      await smtpTransporter.sendMail(mailOptions);
      return { success: true };
    } catch (error) {
      return { success: false, error: 'SMTP failed' };
    }
  }

  // Ticket confirmation email
  static async sendTicketConfirmation(
    to: string, 
    ticketData: TicketConfirmationEmail
  ): Promise<{ success: boolean; error?: string }> {
    const html = this.generateTicketConfirmationHTML(ticketData);
    const text = this.generateTicketConfirmationText(ticketData);

    return this.sendEmail({
      to,
      subject: `Ticket Confirmation - ${ticketData.eventTitle}`,
      html,
      text,
      templateData: ticketData
    });
  }

  // Event reminder email
  static async sendEventReminder(
    to: string,
    reminderData: EventReminderEmail
  ): Promise<{ success: boolean; error?: string }> {
    const html = this.generateEventReminderHTML(reminderData);
    const text = this.generateEventReminderText(reminderData);

    return this.sendEmail({
      to,
      subject: `Reminder: ${reminderData.eventTitle} is tomorrow!`,
      html,
      text,
      templateData: reminderData
    });
  }

  // Newsletter email
  static async sendNewsletter(
    to: string | string[],
    newsletterData: NewsletterEmail
  ): Promise<{ success: boolean; error?: string }> {
    const html = this.generateNewsletterHTML(newsletterData);
    const text = this.generateNewsletterText(newsletterData);

    return this.sendEmail({
      to,
      subject: `${newsletterData.brand === 'konnichiwa' ? 'üáØüáµ' : 'üáÆüá≥'} Cultural Updates & Events`,
      html,
      text
    });
  }

  // Contact response email
  static async sendContactResponse(
    to: string,
    responseData: ContactResponseEmail
  ): Promise<{ success: boolean; error?: string }> {
    const html = this.generateContactResponseHTML(responseData);
    const text = this.generateContactResponseText(responseData);

    return this.sendEmail({
      to,
      subject: `Re: ${responseData.subject}`,
      html,
      text
    });
  }

  // Welcome email for new users
  static async sendWelcomeEmail(
    to: string,
    userName: string,
    brand: 'konnichiwa' | 'namaste'
  ): Promise<{ success: boolean; error?: string }> {
    const html = this.generateWelcomeHTML(userName, brand);
    const text = this.generateWelcomeText(userName, brand);

    return this.sendEmail({
      to,
      subject: `Welcome to ${brand === 'konnichiwa' ? 'Konnichiwa Japan' : 'Namaste India'}!`,
      html,
      text
    });
  }

  // Event update notification
  static async sendEventUpdateNotification(
    to: string | string[],
    eventTitle: string,
    updateType: 'cancelled' | 'modified' | 'rescheduled',
    details: string
  ): Promise<{ success: boolean; error?: string }> {
    const html = this.generateEventUpdateHTML(eventTitle, updateType, details);
    const text = this.generateEventUpdateText(eventTitle, updateType, details);

    return this.sendEmail({
      to,
      subject: `Event Update: ${eventTitle}`,
      html,
      text
    });
  }

  // HTML template generators
  private static generateTicketConfirmationHTML(data: TicketConfirmationEmail): string {
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Ticket Confirmation</title>
        <style>
          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
          .container { max-width: 600px; margin: 0 auto; padding: 20px; }
          .header { background: linear-gradient(135deg, #dc2626, #991b1b); color: white; padding: 20px; text-align: center; }
          .content { padding: 20px; background: #f9f9f9; }
          .ticket-info { background: white; padding: 15px; margin: 15px 0; border-radius: 8px; }
          .footer { text-align: center; padding: 20px; color: #666; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>üéå Ticket Confirmed! üéå</h1>
            <p>Your cultural journey awaits</p>
          </div>
          <div class="content">
            <h2>Hi ${data.userName},</h2>
            <p>Thank you for your purchase! Your ticket has been confirmed.</p>
            
            <div class="ticket-info">
              <h3>Event Details</h3>
              <p><strong>Event:</strong> ${data.eventTitle}</p>
              <p><strong>Date:</strong> ${data.eventDate}</p>
              <p><strong>Location:</strong> ${data.eventLocation}</p>
              <p><strong>Ticket Type:</strong> ${data.ticketType}</p>
              <p><strong>Quantity:</strong> ${data.quantity}</p>
              <p><strong>Total Amount:</strong> ‚Çπ${data.totalAmount}</p>
              <p><strong>Ticket ID:</strong> ${data.ticketId}</p>
            </div>
            
            <p>Please arrive 15 minutes before the event starts. Bring this confirmation email or your ticket ID.</p>
          </div>
          <div class="footer">
            <p>Need help? Contact us at support@konnichiwa-namaste.com</p>
          </div>
        </div>
      </body>
      </html>
    `;
  }

  private static generateTicketConfirmationText(data: TicketConfirmationEmail): string {
    return `
      Ticket Confirmed!
      
      Hi ${data.userName},
      
      Thank you for your purchase! Your ticket has been confirmed.
      
      Event Details:
      Event: ${data.eventTitle}
      Date: ${data.eventDate}
      Location: ${data.eventLocation}
      Ticket Type: ${data.ticketType}
      Quantity: ${data.quantity}
      Total Amount: ‚Çπ${data.totalAmount}
      Ticket ID: ${data.ticketId}
      
      Please arrive 15 minutes before the event starts.
      
      Need help? Contact us at support@konnichiwa-namaste.com
    `;
  }

  private static generateEventReminderHTML(data: EventReminderEmail): string {
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Event Reminder</title>
        <style>
          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
          .container { max-width: 600px; margin: 0 auto; padding: 20px; }
          .header { background: linear-gradient(135deg, #dc2626, #991b1b); color: white; padding: 20px; text-align: center; }
          .content { padding: 20px; background: #f9f9f9; }
          .event-info { background: white; padding: 15px; margin: 15px 0; border-radius: 8px; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>üîî Event Reminder</h1>
          </div>
          <div class="content">
            <h2>Hi ${data.userName},</h2>
            <p>Don't forget! Your cultural experience is coming up soon.</p>
            
            <div class="event-info">
              <h3>${data.eventTitle}</h3>
              <p><strong>Date:</strong> ${data.eventDate}</p>
              <p><strong>Time:</strong> ${data.eventTime}</p>
              <p><strong>Location:</strong> ${data.eventLocation}</p>
              <p><strong>Description:</strong> ${data.eventDescription}</p>
            </div>
            
            <p>We can't wait to see you there!</p>
          </div>
        </div>
      </body>
      </html>
    `;
  }

  private static generateEventReminderText(data: EventReminderEmail): string {
    return `
      Event Reminder
      
      Hi ${data.userName},
      
      Don't forget! Your cultural experience is coming up soon.
      
      ${data.eventTitle}
      Date: ${data.eventDate}
      Time: ${data.eventTime}
      Location: ${data.eventLocation}
      Description: ${data.eventDescription}
      
      We can't wait to see you there!
    `;
  }

  private static generateNewsletterHTML(data: NewsletterEmail): string {
    const brandEmoji = data.brand === 'konnichiwa' ? 'üáØüáµ' : 'üáÆüá≥';
    const brandName = data.brand === 'konnichiwa' ? 'Konnichiwa Japan' : 'Namaste India';
    
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Cultural Newsletter</title>
        <style>
          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
          .container { max-width: 600px; margin: 0 auto; padding: 20px; }
          .header { background: linear-gradient(135deg, #dc2626, #991b1b); color: white; padding: 20px; text-align: center; }
          .content { padding: 20px; }
          .article { background: #f9f9f9; padding: 15px; margin: 15px 0; border-radius: 8px; }
          .footer { text-align: center; padding: 20px; color: #666; }
          .unsubscribe { text-align: center; margin-top: 30px; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>${brandEmoji} ${brandName}</h1>
            <p>Your monthly cultural update</p>
          </div>
          <div class="content">
            <h2>Hi ${data.recipientName},</h2>
            <p>Here's what's happening in our cultural community this month:</p>
            
            ${data.articles.map(article => `
              <div class="article">
                <h3><a href="${article.url}">${article.title}</a></h3>
                <p>${article.excerpt}</p>
                ${article.imageUrl ? `<img src="${article.imageUrl}" alt="${article.title}" style="max-width: 100%; height: auto;">` : ''}
                <p><a href="${article.url}">Read more ‚Üí</a></p>
              </div>
            `).join('')}
          </div>
          <div class="footer">
            <p>Thank you for being part of our cultural community!</p>
            <div class="unsubscribe">
              <p><a href="${data.unsubscribeUrl}">Unsubscribe from these emails</a></p>
            </div>
          </div>
        </div>
      </body>
      </html>
    `;
  }

  private static generateNewsletterText(data: NewsletterEmail): string {
    const brandName = data.brand === 'konnichiwa' ? 'Konnichiwa Japan' : 'Namaste India';
    
    return `
      ${brandName} - Cultural Newsletter
      
      Hi ${data.recipientName},
      
      Here's what's happening in our cultural community this month:
      
      ${data.articles.map(article => `
        ${article.title}
        ${article.excerpt}
        Read more: ${article.url}
      `).join('\n')}
      
      Thank you for being part of our cultural community!
      
      Unsubscribe: ${data.unsubscribeUrl}
    `;
  }

  private static generateContactResponseHTML(data: ContactResponseEmail): string {
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Contact Response</title>
      </head>
      <body>
        <div style="max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;">
          <h2>Hi ${data.userName},</h2>
          <p>Thank you for contacting us. Here's our response to your inquiry about "${data.subject}":</p>
          <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0;">
            ${data.response}
          </div>
          <p>If you have any further questions, please don't hesitate to reach out.</p>
          <p>Best regards,<br>The Cultural Festival Team</p>
        </div>
      </body>
      </html>
    `;
  }

  private static generateContactResponseText(data: ContactResponseEmail): string {
    return `
      Hi ${data.userName},
      
      Thank you for contacting us. Here's our response to your inquiry about "${data.subject}":
      
      ${data.response}
      
      If you have any further questions, please don't hesitate to reach out.
      
      Best regards,
      The Cultural Festival Team
    `;
  }

  private static generateWelcomeHTML(userName: string, brand: 'konnichiwa' | 'namaste'): string {
    const brandEmoji = brand === 'konnichiwa' ? 'üáØüáµ' : 'üáÆüá≥';
    const brandName = brand === 'konnichiwa' ? 'Konnichiwa Japan' : 'Namaste India';
    
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Welcome</title>
      </head>
      <body>
        <div style="max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;">
          <h1>${brandEmoji} Welcome to ${brandName}!</h1>
          <p>Hi ${userName},</p>
          <p>Welcome to our cultural community! We're excited to have you join us on this beautiful journey of cultural exchange and celebration.</p>
          <p>You'll receive updates about upcoming events, cultural workshops, and special announcements.</p>
          <p>Stay tuned for amazing experiences ahead!</p>
          <p>Best regards,<br>The Cultural Festival Team</p>
        </div>
      </body>
      </html>
    `;
  }

  private static generateWelcomeText(userName: string, brand: 'konnichiwa' | 'namaste'): string {
    const brandName = brand === 'konnichiwa' ? 'Konnichiwa Japan' : 'Namaste India';
    
    return `
      Welcome to ${brandName}!
      
      Hi ${userName},
      
      Welcome to our cultural community! We're excited to have you join us on this beautiful journey of cultural exchange and celebration.
      
      You'll receive updates about upcoming events, cultural workshops, and special announcements.
      
      Stay tuned for amazing experiences ahead!
      
      Best regards,
      The Cultural Festival Team
    `;
  }

  private static generateEventUpdateHTML(eventTitle: string, updateType: string, details: string): string {
    const updateEmoji = {
      'cancelled': '‚ùå',
      'modified': '‚úèÔ∏è',
      'rescheduled': 'üìÖ'
    }[updateType] || 'üì¢';
    
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Event Update</title>
      </head>
      <body>
        <div style="max-width: 600px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;">
          <h1>${updateEmoji} Event Update</h1>
          <h2>${eventTitle}</h2>
          <p>We have an important update regarding your upcoming event:</p>
          <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <p><strong>Update Type:</strong> ${updateType.charAt(0).toUpperCase() + updateType.slice(1)}</p>
            <p><strong>Details:</strong> ${details}</p>
          </div>
          <p>If you have any questions, please contact us immediately.</p>
          <p>Thank you for your understanding.</p>
        </div>
      </body>
      </html>
    `;
  }

  private static generateEventUpdateText(eventTitle: string, updateType: string, details: string): string {
    return `
      Event Update: ${eventTitle}
      
      We have an important update regarding your upcoming event:
      
      Update Type: ${updateType.charAt(0).toUpperCase() + updateType.slice(1)}
      Details: ${details}
      
      If you have any questions, please contact us immediately.
      
      Thank you for your understanding.
    `;
  }
}

// Email queue management for bulk sending
export class EmailQueue {
  private static queue: EmailData[] = [];
  private static processing = false;

  static async addToQueue(emailData: EmailData): Promise<void> {
    this.queue.push(emailData);
    if (!this.processing) {
      this.processQueue();
    }
  }

  private static async processQueue(): Promise<void> {
    this.processing = true;
    
    while (this.queue.length > 0) {
      const emailData = this.queue.shift()!;
      try {
        await EmailService.sendEmail(emailData);
        // Add delay between emails to avoid rate limiting
        await new Promise(resolve => setTimeout(resolve, 100));
      } catch (error) {
      }
    }
    
    this.processing = false;
  }
}